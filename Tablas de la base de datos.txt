-- Nivel 0: Tablas sin dependencias
-- Estas tablas no dependen de ninguna otra.

CREATE TABLE public."areasA" (
  id_area smallint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  nombre_area text NOT NULL,
  descripcion_area text NULL,
  id_empleado_responsable bigint NULL,
  CONSTRAINT "areasA_pkey" PRIMARY KEY (id_area)
) TABLESPACE pg_default;

CREATE TABLE public."capacitacionesS" (
  id_capacitacion bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  tema text NOT NULL,
  descripcion text NULL,
  fecha_inicio_capacitacion date NULL,
  fecha_fin_capacitacion date NULL,
  instructor text NULL,
  tipo_capacitacion text NULL,
  CONSTRAINT "capacitacionesS_pkey" PRIMARY KEY (id_capacitacion)
) TABLESPACE pg_default;

CREATE TABLE public."equipos_proteccionS" (
  id_equipo_proteccion bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  nombre_equipo bigint NOT NULL,
  descripcion_equipo text NULL,
  vida_util_equipo text NULL,
  nomas_seguridad text NULL,
  CONSTRAINT "equipos_proteccionS_pkey" PRIMARY KEY (id_equipo_proteccion)
) TABLESPACE pg_default;

CREATE TABLE public."permisos_C" (
  id_permiso bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  nombre_permiso character varying NOT NULL,
  descripcion text NULL DEFAULT ''::text,
  CONSTRAINT "permisos_C_pkey" PRIMARY KEY (id_permiso),
  CONSTRAINT "permisos_C_id_permiso_key" UNIQUE (id_permiso),
  CONSTRAINT "permisos_C_nombre_permiso_key" UNIQUE (nombre_permiso)
) TABLESPACE pg_default;

CREATE TABLE public."roles_C" (
  id_rol bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  nombre_rol character varying NULL,
  descripcion text NULL,
  CONSTRAINT "roles_C_pkey" PRIMARY KEY (id_rol),
  CONSTRAINT "roles_C_id_rol_key" UNIQUE (id_rol),
  CONSTRAINT "roles_C_nombre_rol_key" UNIQUE (nombre_rol)
) TABLESPACE pg_default;

-- Nivel 1: Dependen del Nivel 0
-- (puestosA, vacantesA, rol-permisos_C)

CREATE TABLE public."puestosA" (
  id_puesto bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  nombre_puesto text NOT NULL,
  id_area smallint NULL,
  descripcion_funciones text NULL,
  salario_base numeric NULL,
  CONSTRAINT "puestosA_pkey" PRIMARY KEY (id_puesto)
  -- Nota: Te sugiero agregar: CONSTRAINT "puestosA_id_area_fkey" FOREIGN KEY (id_area) REFERENCES public."areasA" (id_area)
) TABLESPACE pg_default;

CREATE TABLE public."candidatosA" (
  id_candidato bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  nombre text NOT NULL,
  apellido_paterno text NULL,
  apellido_materno text NULL,
  correo text NOT NULL,
  telefono text NULL,
  cv_url text NULL,
  origen_postulacion text NULL,
  fecha_registro timestamp WITH TIME ZONE NOT NULL DEFAULT NOW(),
  estado_contacto text NULL DEFAULT 'Pendiente',
  notas text NULL,
  CONSTRAINT "candidatosA_pkey" PRIMARY KEY (id_candidato),
  CONSTRAINT "candidatosA_correo_key" UNIQUE (correo)
) TABLESPACE pg_default;

CREATE TABLE public."vacantesA" (
  id_vacante bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  id_puesto bigint NOT NULL,
  tipo_vacante text NULL,
  fecha_apertura date NULL,
  estado_vacante text NULL,
  id_candidato bigint NULL,
  CONSTRAINT "vacantesA_pkey" PRIMARY KEY (id_vacante)
  -- Nota: Te sugiero agregar: CONSTRAINT "vacantesA_id_puesto_fkey" FOREIGN KEY (id_puesto) REFERENCES public."puestosA" (id_puesto)
) TABLESPACE pg_default;

CREATE TABLE public."rol-permisos_C" (
  id_rol bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  id_permisos bigint NOT NULL,
  CONSTRAINT "rol - permisos_C_pkey" PRIMARY KEY (id_rol, id_permisos),
  CONSTRAINT "rol - permisos_C_id_permisos_fkey" FOREIGN KEY (id_permisos) REFERENCES "permisos_C" (id_permiso),
  CONSTRAINT "rol - permisos_C_id_rol_fkey" FOREIGN KEY (id_rol) REFERENCES "roles_C" (id_rol)
) TABLESPACE pg_default;

-- Nivel 2: Dependen del Nivel 1 (Principalmente "puestosA")
-- ("empleados_C")

CREATE TABLE public."empleados_C" (
  id_empleado bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  auth_user_id uuid NOT NULL DEFAULT auth.uid (),
  "P_nombre" character varying NOT NULL,
  "S_nombre" character varying NULL,
  "apellido_P" character varying NULL,
  "apellido_M" character varying NULL,
  fecha_de_nacimiento date NOT NULL,
  curp character varying NOT NULL,
  rfc character varying NOT NULL,
  nss character varying NOT NULL,
  sexo character varying NULL,
  nacionalidad character varying NOT NULL,
  correo_personal character varying NULL,
  correo_empresa character varying NOT NULL,
  fecha_de_ingreso date NOT NULL,
  estatus character varying NULL DEFAULT '''Activo'''::character varying,
  id_puesto_actual bigint NULL,
  CONSTRAINT "empleados_C_pkey" PRIMARY KEY (id_empleado),
  CONSTRAINT "empleados_C_auth_user_id_key" UNIQUE (auth_user_id),
  CONSTRAINT "empleados_C_correo_empresa_key" UNIQUE (correo_empresa),
  CONSTRAINT "empleados_C_correo_personal_key" UNIQUE (correo_personal),
  CONSTRAINT "empleados_C_curp_key" UNIQUE (curp),
  CONSTRAINT "empleados_C_nss_key" UNIQUE (nss),
  CONSTRAINT "empleados_C_rfc_key" UNIQUE (rfc),
  CONSTRAINT "empleados_C_auth_user_id_fkey" FOREIGN KEY (auth_user_id) REFERENCES auth.users (id),
  CONSTRAINT "empleados_C_id_puesto_actual_fkey" FOREIGN KEY (id_puesto_actual) REFERENCES "puestosA" (id_puesto)
) TABLESPACE pg_default;

-- Nivel 3: Dependen de "empleados_C" y otros.
-- (La mayoría de las tablas caen aquí)

CREATE TABLE public."asignacionesA" (
  id_asignacion bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  id_empleado bigint NOT NULL,
  id_puesto bigint NULL,
  fecha_inicio_asignacion date NULL,
  fecha_fin_asignacion date NULL,
  tipo_asignacion text NULL,
  CONSTRAINT "asignacionesA_pkey" PRIMARY KEY (id_asignacion)
  -- Nota: Te sugiero agregar FKs para id_empleado y id_puesto
) TABLESPACE pg_default;

CREATE TABLE public."capacitacion_empleadoS" (
  id_capacitacion_empleado bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  id_empleado bigint NOT NULL,
  id_capacitacion bigint NULL,
  status text NULL,
  calificacion smallint NULL,
  CONSTRAINT "capacitacion_empleadoS_pkey" PRIMARY KEY (id_capacitacion_empleado)
  -- Nota: Te sugiero agregar FKs para id_empleado y id_capacitacion
) TABLESPACE pg_default;

CREATE TABLE public."contratos_C" (
  id_contrato bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  id_empleado bigint NOT NULL,
  id_puesto bigint NOT NULL,
  estatus_contrato character varying NOT NULL DEFAULT '''Activo'''::character varying,
  tipo_contrato character varying NOT NULL,
  fecha_inicio date NOT NULL,
  fecha_fin date NOT NULL,
  salario numeric NOT NULL,
  forma_pago character varying NOT NULL,
  jornada character varying NOT NULL,
  id_contrato_anterior bigint NULL,
  motivo_finalizacion text NULL DEFAULT ''::text,
  fecha_firma date NOT NULL,
  CONSTRAINT "contratos_c_pkey" PRIMARY KEY (id_contrato),
  CONSTRAINT "contratos_c_id_contrato_key" UNIQUE (id_contrato),
  CONSTRAINT "contratos_c_id_empleado_fkey" FOREIGN KEY (id_empleado) REFERENCES "empleados_C" (id_empleado),
  CONSTRAINT "contratos_c_id_puesto_fkey" FOREIGN KEY (id_puesto) REFERENCES "puestosA" (id_puesto)
) TABLESPACE pg_default;

CREATE TABLE public."datos_biometricos_C" (
  id_biometrico bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  id_empleado bigint NOT NULL,
  huella_dactilar character varying NOT NULL,
  descripcion_biometrico character varying NOT NULL,
  plantilla_biometrica bytea NOT NULL,
  id_dispositivo_registro character varying NOT NULL,
  esta_activo boolean NULL DEFAULT true,
  fecha_registro timestamp WITH TIME ZONE NOT NULL DEFAULT NOW(),
  CONSTRAINT "datos_biometricos_C_pkey" PRIMARY KEY (id_biometrico),
  CONSTRAINT "datos_biometricos_C_id_biometrico_key" UNIQUE (id_biometrico),
  CONSTRAINT "datos_biometricos_C_id_empleado_fkey" FOREIGN KEY (id_empleado) REFERENCES "empleados_C" (id_empleado)
) TABLESPACE pg_default;

CREATE TABLE public."direcciones_C" (
  id_direccion bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  id_empleado bigint NOT NULL,
  calle character varying NOT NULL,
  numero_exterior character varying NULL,
  numero_interior character varying NULL,
  colonia character varying NOT NULL,
  municipio character varying NOT NULL,
  ciudad character varying NOT NULL,
  estado character varying NOT NULL,
  codigo_postal character varying NOT NULL,
  es_principal boolean NOT NULL DEFAULT false,
  CONSTRAINT "direcciones_C_pkey" PRIMARY KEY (id_direccion),
  CONSTRAINT "direcciones_C_id_direccion_key" UNIQUE (id_direccion),
  CONSTRAINT "direcciones_C_id_empleado_fkey" FOREIGN KEY (id_empleado) REFERENCES "empleados_C" (id_empleado)
) TABLESPACE pg_default;

CREATE TABLE public.documentos (
  id serial NOT NULL,
  id_empleado bigint NULL,
  tipo_documento character varying(100) NULL,
  nombre_original character varying(255) NULL,
  storage_path text NOT NULL,
  url_publica text NOT NULL,
  mime_type character varying(100) NULL DEFAULT 'application/pdf'::character varying,
  size_bytes bigint NULL,
  fecha_subida timestamp WITH TIME ZONE NULL DEFAULT NOW(),
  CONSTRAINT documentos_pkey PRIMARY KEY (id),
  CONSTRAINT documentos_id_empleado_fkey FOREIGN KEY (id_empleado) REFERENCES "empleados_C" (id_empleado) ON DELETE CASCADE,
  CONSTRAINT documentos_tipo_documento_check CHECK (
    (
      (tipo_documento)::text = ANY (
        (
          ARRAY[
            'contrato'::character varying,
            'curriculum'::character varying,
            'reporte'::character varying,
            'solicitud_vacaciones'::character varying,
            'constancia'::character varying,
            'entrevista'::character varying
          ]
        )::text[]
      )
    )
  )
) TABLESPACE pg_default;

CREATE TABLE public."empleados_roles_C" (
  id_empleado bigint NOT NULL,
  id_rol bigint NOT NULL,
  fecha_asignacion timestamp WITH TIME ZONE NULL DEFAULT NOW(),
  id_usuario_asignador bigint NULL,
  motivo_asignacion text NULL DEFAULT ''::text,
  CONSTRAINT "empleados_roles_C_pkey" PRIMARY KEY (id_empleado, id_rol),
  CONSTRAINT empleados_roles_id_empleado_fkey FOREIGN KEY (id_empleado) REFERENCES "empleados_C" (id_empleado),
  CONSTRAINT empleados_roles_id_usuario_asignador_fkey FOREIGN KEY (id_usuario_asignador) REFERENCES "empleados_C" (id_empleado),
  CONSTRAINT empleados_roles_ir_rol_fkey FOREIGN KEY (id_rol) REFERENCES "roles_C" (id_rol)
) TABLESPACE pg_default;

CREATE TABLE public."expedientes_digitales_C" (
  id_documento bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  id_empleado bigint NOT NULL,
  tipo_documento character varying NOT NULL,
  url_archivo character varying NOT NULL,
  nombre_archivo_original character varying NOT NULL,
  tipo_archivo character varying NULL,
  tamano_archivo bigint NULL,
  fecha_entrega date NOT NULL,
  fecha_vencimiento date NULL,
  estado_validacion character varying NOT NULL DEFAULT '''Pendiente'''::character varying,
  id_usuario_validacion bigint NULL,
  fecha_validacion timestamp WITH TIME ZONE NULL,
  notas_validacion text NULL DEFAULT ''::text,
  id_documento_anterior bigint NULL,
  CONSTRAINT "expedientes_digitales_C_pkey" PRIMARY KEY (id_documento),
  CONSTRAINT "expedientes_digitales_C_id_documento_key" UNIQUE (id_documento),
  CONSTRAINT "expedientes_digitales_C_id_empleado_fkey" FOREIGN KEY (id_empleado) REFERENCES "empleados_C" (id_empleado),
  CONSTRAINT "expedientes_digitales_C_id_usuario_validacion_fkey" FOREIGN KEY (id_usuario_validacion) REFERENCES "empleados_C" (id_empleado)
) TABLESPACE pg_default;

CREATE TABLE public.incidencia (
  id_incidencia bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  id_empleado bigint NOT NULL,
  fecha_incidencia timestamp WITHOUT TIME ZONE NULL,
  tipo_incidencia text NULL,
  descripcion_incidencia text NULL,
  evidencia_incidencia text NULL,
  accion_tomada text NULL,
  estado boolean NULL,
  CONSTRAINT incidencia_pkey PRIMARY KEY (id_incidencia),
  CONSTRAINT fk_incidencia_empleado FOREIGN KEY (id_empleado) REFERENCES "empleados_C" (id_empleado) ON UPDATE CASCADE ON DELETE RESTRICT
) TABLESPACE pg_default;

CREATE TABLE public."incidentesS" (
  id_incidente bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  id_empleado bigint NOT NULL,
  id_area smallint NULL,
  fecha_incidente timestamp WITHOUT TIME ZONE NULL,
  descripcion_incidente text NULL,
  tipo_incidente text NULL,
  nivel_gravedad text NULL,
  acciones_tomadas_incidente text NULL,
  CONSTRAINT "incidentesS_pkey" PRIMARY KEY (id_incidente)
  -- Nota: Te sugiero agregar FKs para id_empleado y id_area
) TABLESPACE pg_default;

CREATE TABLE public."telefonos_C" (
  id_telefono bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  id_empleado bigint NOT NULL,
  numero character varying NOT NULL,
  tipo character varying NOT NULL,
  es_principal boolean NOT NULL DEFAULT false,
  CONSTRAINT "telefonos_C_pkey" PRIMARY KEY (id_telefono),
  CONSTRAINT "telefonos_C_id_telefono_key" UNIQUE (id_telefono),
  CONSTRAINT "telefonos_C_id_empleado_fkey" FOREIGN KEY (id_empleado) REFERENCES "empleados_C" (id_empleado)
) TABLESPACE pg_default;

-- Nivel 4: Dependen de "incidencia" y "empleados_C"

CREATE TABLE public.despido (
  id_despido bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  id_empleado bigint NOT NULL,
  incidencias_relacionadas text NULL,
  fechas_despido timestamp WITHOUT TIME ZONE NULL,
  causa_despido text NULL,
  documentacion_despido text NULL,
  estado_despido text NULL,
  id_incidencia bigint NULL,
  CONSTRAINT despido_pkey PRIMARY KEY (id_despido),
  CONSTRAINT uq_despido_empleado UNIQUE (id_empleado),
  CONSTRAINT fk_despido_empleado FOREIGN KEY (id_empleado) REFERENCES "empleados_C" (id_empleado) ON UPDATE CASCADE ON DELETE RESTRICT,
  CONSTRAINT fk_despido_incidencia FOREIGN KEY (id_incidencia) REFERENCES incidencia (id_incidencia) ON UPDATE CASCADE ON DELETE SET NULL
) TABLESPACE pg_default;

CREATE TABLE public."registro_asistencias_C" (
  id_asistencia bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  id_empleado bigint NOT NULL,
  fecha_hora timestamp WITH TIME ZONE NOT NULL,
  tipo_evento character varying NOT NULL,
  estatis_registro character varying NOT NULL DEFAULT '''Normal'''::character varying,
  metodo_registro character varying NOT NULL DEFAULT '''Huella'''::character varying,
  id_dispositivo character varying NOT NULL,
  id_incidencia_justificante bigint NULL,
  CONSTRAINT "registro_asistencias_C_pkey" PRIMARY KEY (id_asistencia),
  CONSTRAINT "registro_asistencias_C_id_asistencia_key" UNIQUE (id_asistencia),
  CONSTRAINT "registro_asistencias_C_id_empleado_fkey" FOREIGN KEY (id_empleado) REFERENCES "empleados_C" (id_empleado),
  CONSTRAINT "registro_asistencias_C_id_incidencia_justificante_fkey" FOREIGN KEY (id_incidencia_justificante) REFERENCES incidencia (id_incidencia)
) TABLESPACE pg_default;

-- Nivel 5: Dependen del Nivel 4

-- REEMPLAZA LA ÚLTIMA TABLA DEL SCRIPT DE ARRIBA POR ESTA:
CREATE TABLE public."Solicitud_Vacaciones" (
  "id_Solicitud" bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  
  -- COLUMNAS CORREGIDAS PARA LAS LLAVES FORÁNEAS:
  "id_empleado" bigint NOT NULL, 
  "id_contrato" bigint NULL,
  
  descripcion_solicitud text NOT NULL,
  fecha_inicio date NULL,
  fecha_fin date NULL,
  observaciones text NULL,
  estatus character varying NULL,
  
  CONSTRAINT "Solicitud_Vacaciones_pkey" PRIMARY KEY ("id_Solicitud"),
  
  -- CONSTRAINTS CORREGIDOS:
  CONSTRAINT "Solicitud_Vacaciones_id_empleado_fkey" FOREIGN KEY ("id_empleado") REFERENCES "empleados_C" (id_empleado),
  CONSTRAINT "Solicitud_Vacaciones_id_contrato_fkey" FOREIGN KEY ("id_contrato") REFERENCES "contratos_C" (id_contrato)
) TABLESPACE pg_default;

-- Nivel 2A: Intermedia entre candidatos y vacantes

CREATE TABLE public."candidatos_postulacionesA" (
  id_postulacion bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  id_candidato bigint NOT NULL,
  id_vacante bigint NOT NULL,
  fecha_postulacion date NOT NULL DEFAULT CURRENT_DATE,
  estado_postulacion text NULL DEFAULT 'Pendiente',
  etapa_actual text NULL,
  probabilidad numeric NULL,
  comentarios text NULL,
  fecha_actualizacion timestamp WITH TIME ZONE NULL DEFAULT NOW(),
  CONSTRAINT "candidatos_postulacionesA_pkey" PRIMARY KEY (id_postulacion),
  CONSTRAINT "candidatos_postulacionesA_uk" UNIQUE (id_candidato, id_vacante),
  CONSTRAINT "candidatos_postulacionesA_id_candidato_fkey" FOREIGN KEY (id_candidato) REFERENCES "candidatosA" (id_candidato) ON DELETE CASCADE,
  CONSTRAINT "candidatos_postulacionesA_id_vacante_fkey" FOREIGN KEY (id_vacante) REFERENCES "vacantesA" (id_vacante) ON DELETE CASCADE
) TABLESPACE pg_default;

CREATE TABLE public."candidatos_entrevistasA" (
  id_entrevista bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  id_postulacion bigint NOT NULL,
  fecha_entrevista date NOT NULL,
  hora_entrevista time NOT NULL,
  tipo_entrevista text NULL,
  entrevistador text NULL,
  enlace_reunion text NULL,
  estado_entrevista text NOT NULL DEFAULT 'Programada',
  notas text NULL,
  fecha_creacion timestamp WITH TIME ZONE NOT NULL DEFAULT NOW(),
  fecha_actualizacion timestamp WITH TIME ZONE NULL DEFAULT NOW(),
  CONSTRAINT "candidatos_entrevistasA_pkey" PRIMARY KEY (id_entrevista),
  CONSTRAINT "candidatos_entrevistasA_id_postulacion_fkey" FOREIGN KEY (id_postulacion) REFERENCES "candidatos_postulacionesA" (id_postulacion) ON DELETE CASCADE
) TABLESPACE pg_default;