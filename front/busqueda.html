<!DOCTYPE html>
<html lang="es" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>B√∫squeda de Incidencias</title>

    <!-- Tailwind + DaisyUI Cesar-->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css"
      rel="stylesheet"
      type="text/css"
    />

    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      .clickable-stat:hover {
        cursor: pointer;
        transform: translateY(-2px);
        transition: all 0.2s ease;
      }
      .stat-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: #f3f4f6;
      }
      .stat-title {
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
      .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
      }
      .loading {
        opacity: 0.6;
        pointer-events: none;
      }
    </style>
  </head>

  <body class="bg-base-300 h-screen flex flex-col">
    <!-- Header -->
    <header class="navbar bg-orange-400 text-white px-6 h-16 flex-none">
      <div class="flex-1">
        <h1 class="text-2xl font-bold">Incidencias: B√∫squeda</h1>
      </div>
      <div class="flex-none text-3xl font-bold">H</div>
    </header>

    <main class="flex flex-1 overflow-hidden">
      <aside
        class="w-64 bg-base-100 p-6 shadow-md flex flex-col h-full justify-between"
      >
        <h2 class="text-xl font-semibold mb-6">Men√∫</h2>
        <div class="flex flex-col space-y-3 flex-grow">
          <a href="dashboard.html" class="btn bg-orange-400 hover:bg-yellow-500 text-black font-semibold w-full">
            Inicio
          </a>
           <a href="formulatio.html" class="btn bg-orange-400 hover:bg-yellow-500 text-black font-semibold w-full">Crear Incidencia</a>
          <button class="btn btn-neutral w-full">Buscar Incidencia</button>
        </div>
        <div
          class="mt-auto text-sm text-center text-gray-500 pt-4 border-t border-gray-300"
        >
          Incidencias y Despidos
        </div>
      </aside>

      <!-- Secci√≥n principal de b√∫squeda -->
      <section class="flex-1 overflow-auto p-8">
        <!-- Loading State -->
        <div id="loading-state" class="fixed inset-0 bg-base-100 bg-opacity-80 flex items-center justify-center z-50 hidden">
          <div class="text-center">
            <div class="loading loading-spinner loading-lg text-orange-400 mb-4"></div>
            <p class="text-lg font-semibold">Cargando datos...</p>
          </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="card bg-base-100 shadow-xl mb-6">
          <div class="card-body">
            <h2 class="card-title text-lg font-semibold">Total de Incidencias</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
              <div class="stat-container clickable-stat" onclick="filtrarPorTipo('todos')">
                <div class="stat-title">Total de incidencias</div>
                <div class="stat-value" id="total-incidencias">0</div>
              </div>
              <div class="stat-container clickable-stat" onclick="filtrarPorTipo('Retardo')">
                <div class="stat-title">Retardos</div>
                <div class="stat-value" id="total-retardos">0</div>
              </div>
              <div class="stat-container clickable-stat" onclick="filtrarPorTipo('Enfermedad')">
                <div class="stat-title">Enfermedad</div>
                <div class="stat-value" id="total-enfermedad">0</div>
              </div>
              <div class="stat-container clickable-stat" onclick="filtrarPorTipo('Despido')">
                <div class="stat-title">Despidos</div>
                <div class="stat-value" id="total-despidos">0</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Filtros y tabla -->
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body overflow-auto">
            <!-- Pesta√±as de filtro -->
            <div class="tabs tabs-boxed bg-base-200 w-fit mb-4" id="filtro-estado">
              <a class="tab tab-active" onclick="filtrarPorEstado('todos')">All</a> 
              <a class="tab" onclick="filtrarPorEstado('false')">Incomplete</a> 
              <a class="tab" onclick="filtrarPorEstado('true')">Finished</a>
            </div>

            <!-- Tabla de incidencias -->
            <div class="overflow-x-auto">
              <table class="table table-zebra w-full" id="tabla-incidencias">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Acci√≥n</th>
                  </tr>
                </thead>
                <tbody id="cuerpo-tabla">
                  <!-- Las filas se generar√°n din√°micamente con JavaScript -->
                </tbody>
              </table>
            </div>

            <!-- Botones de Reporte -->
            <div class="card-actions justify-end mt-6 space-x-4">
              <button class="btn btn-neutral" onclick="mostrarModalReporteDespidos()">Reporte Despidos</button>
              <button class="btn btn-neutral" onclick="mostrarModalReporteGeneral()">Generar Reporte</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Modal para detalles de incidencia - MEJORADO -->
    <input type="checkbox" id="modal-detalles" class="modal-toggle" />
    <div class="modal">
      <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-lg mb-4" id="modal-titulo">Detalles de Incidencia</h3>
        <div class="py-4" id="modal-contenido">
          <!-- Contenido din√°mico -->
        </div>
        
        <div class="modal-action">
          <label for="modal-detalles" class="btn">Cerrar</label>
        </div>
      </div>
    </div>

    <!-- Modal para editar incidencia - NUEVO -->
    <input type="checkbox" id="modal-editar" class="modal-toggle" />
    <div class="modal">
      <div class="modal-box max-w-3xl">
        <h3 class="font-bold text-lg mb-4">Editor Incidencia</h3>
        <div class="py-4">
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="label">
                <span class="label-text font-semibold">Tipo de Incidencia</span>
              </label>
              <select class="select select-bordered w-full" id="edit-tipo-incidencia">
                <option value="Retardo">Retardo</option>
                <option value="Enfermedad">Enfermedad</option>
                <option value="Despido">Despido</option>
              </select>
            </div>
            <div>
              <label class="label">
                <span class="label-text font-semibold">Estado</span>
              </label>
              <select class="select select-bordered w-full" id="edit-estado-incidencia">
                <option value="false">Incompleto</option>
                <option value="true">Completado</option>
              </select>
            </div>
          </div>
          
          <div class="mb-4">
            <label class="label">
              <span class="label-text font-semibold">Descripci√≥n</span>
            </label>
            <textarea class="textarea textarea-bordered w-full h-32" id="edit-descripcion-incidencia" placeholder="Ingrese la descripci√≥n de la incidencia"></textarea>
          </div>
          
          <div class="mb-4">
            <label class="label">
              <span class="label-text font-semibold">Acci√≥n Tomada</span>
            </label>
            <textarea class="textarea textarea-bordered w-full h-24" id="edit-accion-tomada" placeholder="Ingrese la acci√≥n tomada"></textarea>
          </div>
        </div>
        
        <div class="modal-action">
          <label for="modal-editar" class="btn">Cancelar</label>
          <button class="btn btn-primary" onclick="guardarCambios()">Guardar Cambios</button>
        </div>
      </div>
    </div>

    <!-- Modal para confirmar eliminaci√≥n - MEJORADO -->
    <input type="checkbox" id="modal-eliminar" class="modal-toggle" />
    <div class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg">Confirmar Eliminaci√≥n</h3>
        <div class="py-4">
          <p id="texto-eliminar">¬øEst√° seguro de eliminar la incidencia?</p>
        </div>
        <div class="modal-action">
          <label for="modal-eliminar" class="btn">Cancelar</label>
          <button class="btn btn-error" id="btn-confirmar-eliminar">Eliminar</button>
        </div>
      </div>
    </div>

    <!-- Modal para confirmar generaci√≥n de reporte general - MEJORADO -->
    <input type="checkbox" id="modal-reporte-general" class="modal-toggle" />
    <div class="modal">
      <div class="modal-box max-w-3xl">
        <h3 class="font-bold text-lg">Confirmar Generaci√≥n de Reporte</h3>
        <div class="py-4">
          <p>¬øEst√° seguro de que desea generar el reporte general de incidencias?</p>
          <p class="mt-2">Se generar√° un archivo PDF con todas las incidencias registradas en el sistema.</p>
          
          <div class="overflow-x-auto mt-4">
            <table class="table table-zebra w-full" id="tabla-reporte-general">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Fecha</th>
                  <th>Tipo</th>
                </tr>
              </thead>
              <tbody>
                <!-- Se llenar√° din√°micamente -->
              </tbody>
            </table>
          </div>
          
          <div class="mt-4">
            <h4 class="font-semibold">Resumen</h4>
            <div class="flex space-x-4 mt-2">
              <div class="stat bg-base-200 rounded-lg p-4">
                <div class="stat-title">Total</div>
                <div class="stat-value text-lg" id="resumen-total">0</div>
              </div>
              <div class="stat bg-base-200 rounded-lg p-4">
                <div class="stat-title">Retardos</div>
                <div class="stat-value text-lg" id="resumen-retardos">0</div>
              </div>
              <div class="stat bg-base-200 rounded-lg p-4">
                <div class="stat-title">Enfermedad</div>
                <div class="stat-value text-lg" id="resumen-enfermedad">0</div>
              </div>
              <div class="stat bg-base-200 rounded-lg p-4">
                <div class="stat-title">Despidos</div>
                <div class="stat-value text-lg" id="resumen-despidos">0</div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-action">
          <label for="modal-reporte-general" class="btn">Cancelar</label>
          <button class="btn btn-neutral" onclick="generarReporteGeneral()">Generar Reporte</button>
        </div>
      </div>
    </div>

    <!-- Modal para confirmar generaci√≥n de reporte de despidos - MEJORADO -->
    <input type="checkbox" id="modal-reporte-despidos" class="modal-toggle" />
    <div class="modal">
      <div class="modal-box max-w-3xl">
        <h3 class="font-bold text-lg">Confirmar Generaci√≥n de Reporte</h3>
        <div class="py-4">
          <p>¬øEst√° seguro de que desea generar el reporte de despidos?</p>
          <p class="mt-2">Se generar√° un archivo PDF con todos los despidos registrados en el sistema.</p>
          
          <div class="overflow-x-auto mt-4">
            <table class="table table-zebra w-full" id="tabla-reporte-despidos">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Fecha</th>
                  <th>Causa</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody>
                <!-- Se llenar√° din√°micamente -->
              </tbody>
            </table>
          </div>
          
          <div class="mt-4">
            <h4 class="font-semibold">Resumen</h4>
            <div class="flex space-x-4 mt-2">
              <div class="stat bg-base-200 rounded-lg p-4">
                <div class="stat-title">Total Despidos</div>
                <div class="stat-value text-lg" id="resumen-total-despidos">0</div>
              </div>
              <div class="stat bg-base-200 rounded-lg p-4">
                <div class="stat-title">En Proceso</div>
                <div class="stat-value text-lg" id="resumen-despidos-proceso">0</div>
              </div>
              <div class="stat bg-base-200 rounded-lg p-4">
                <div class="stat-title">Completados</div>
                <div class="stat-value text-lg" id="resumen-despidos-completados">0</div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-action">
          <label for="modal-reporte-despidos" class="btn">Cancelar</label>
          <button class="btn btn-neutral" onclick="generarReporteDespidos()">Generar Reporte</button>
        </div>
      </div>
    </div>

    <script>
      // URL base de la API Flask
      const API_BASE_URL = 'http://localhost:5000';
      
      // Estructura de datos
      let empleados = [];
      let incidencias = [];
      let despidos = [];

      // Variables para filtros
      let filtroTipoActual = 'todos';
      let filtroEstadoActual = 'todos';
      let incidenciaAEliminar = null;
      let incidenciaAEditar = null;

      // Inicializar la tabla al cargar la p√°gina
      document.addEventListener('DOMContentLoaded', function() {
        cargarDatosIniciales();
        
        // Configurar eventos para modales
        document.getElementById('btn-confirmar-eliminar').addEventListener('click', confirmarEliminar);
      });

      // Funci√≥n para mostrar/ocultar loading
      function mostrarLoading(mostrar) {
        const loadingElement = document.getElementById('loading-state');
        if (mostrar) {
          loadingElement.classList.remove('hidden');
        } else {
          loadingElement.classList.add('hidden');
        }
      }

      // Funci√≥n para manejar errores de API
      function manejarError(error, mensaje = 'Error al procesar la solicitud') {
        console.error(mensaje, error);
        alert(`${mensaje}: ${error.message || 'Error desconocido'}`);
      }

      // Funci√≥n para cargar datos iniciales desde la API
      async function cargarDatosIniciales() {
        try {
          mostrarLoading(true);
          
          // Cargar incidencias
          const responseIncidencias = await fetch(`${API_BASE_URL}/incidencias`);
          if (!responseIncidencias.ok) {
            throw new Error('Error al cargar incidencias');
          }
          incidencias = await responseIncidencias.json();

          // Nota: En una implementaci√≥n real, tambi√©n cargar√≠amos empleados y despidos
          // Por ahora usamos datos simulados para empleados
          empleados = await cargarEmpleados();

          actualizarEstadisticas();
          renderizarTabla();
        } catch (error) {
          manejarError(error, 'Error al cargar datos iniciales');
        } finally {
          mostrarLoading(false);
        }
      }

      // Funci√≥n para cargar empleados (simulada por ahora)
      async function cargarEmpleados() {
        // En una implementaci√≥n real, esto har√≠a una llamada a la API
        return [
          { id_empleado: 1, P_nombre: "Carlos", apellido_P: "Mendoza", correo_empresa: "carlos.mendoza@empresa.com" },
          { id_empleado: 2, P_nombre: "Ana", apellido_P: "L√≥pez", correo_empresa: "ana.lopez@empresa.com" },
          { id_empleado: 3, P_nombre: "Roberto", apellido_P: "Silva", correo_empresa: "roberto.silva@empresa.com" },
          { id_empleado: 4, P_nombre: "Esther", apellido_P: "Klein", correo_empresa: "esther.klein@empresa.com" },
          { id_empleado: 5, P_nombre: "Denise", apellido_P: "Kuhn", correo_empresa: "denise.kuhn@empresa.com" },
          { id_empleado: 6, P_nombre: "Clint", apellido_P: "Hoppe", correo_empresa: "clint.hoppe@empresa.com" },
          { id_empleado: 7, P_nombre: "Darin", apellido_P: "Deckow", correo_empresa: "darin.deckow@empresa.com" },
          { id_empleado: 8, P_nombre: "Mar√≠a", apellido_P: "Gonz√°lez", correo_empresa: "maria.gonzalez@empresa.com" }
        ];
      }

      // Funci√≥n para obtener nombre completo del empleado
      function obtenerNombreEmpleado(id_empleado) {
        const empleado = empleados.find(e => e.id_empleado === id_empleado);
        return empleado ? `${empleado.P_nombre} ${empleado.apellido_P}` : 'Empleado no encontrado';
      }

      // Funci√≥n para formatear fecha
      function formatearFecha(fechaString) {
        if (!fechaString) return 'No especificada';
        const fecha = new Date(fechaString);
        return fecha.toLocaleDateString('es-ES', {
          day: 'numeric',
          month: 'short',
          year: 'numeric'
        });
      }

      // Funci√≥n para actualizar las estad√≠sticas
      function actualizarEstadisticas() {
        const total = incidencias.length;
        const retardos = incidencias.filter(i => i.tipo_incidencia === 'Retardo').length;
        const enfermedad = incidencias.filter(i => i.tipo_incidencia === 'Enfermedad').length;
        const despidosCount = incidencias.filter(i => i.tipo_incidencia === 'Despido').length;

        document.getElementById('total-incidencias').textContent = total;
        document.getElementById('total-retardos').textContent = retardos;
        document.getElementById('total-enfermedad').textContent = enfermedad;
        document.getElementById('total-despidos').textContent = despidosCount;
      }

      // Funci√≥n para renderizar la tabla con filtros aplicados
      function renderizarTabla() {
        const cuerpoTabla = document.getElementById('cuerpo-tabla');
        cuerpoTabla.innerHTML = '';

        // Aplicar filtros
        let incidenciasFiltradas = incidencias;
        
        if (filtroTipoActual !== 'todos') {
          incidenciasFiltradas = incidenciasFiltradas.filter(i => 
            i.tipo_incidencia === filtroTipoActual
          );
        }
        
        if (filtroEstadoActual !== 'todos') {
          if (filtroEstadoActual === 'true' || filtroEstadoActual === 'false') {
            incidenciasFiltradas = incidenciasFiltradas.filter(i => 
              i.estado.toString() === filtroEstadoActual
            );
          }
        }

        // Generar filas de la tabla
        incidenciasFiltradas.forEach(incidencia => {
          const fila = document.createElement('tr');
          
          // Determinar clase del badge seg√∫n el tipo
          let badgeClass = 'badge ';
          switch(incidencia.tipo_incidencia) {
            case 'Retardo':
              badgeClass += 'badge-warning';
              break;
            case 'Enfermedad':
              badgeClass += 'badge-info';
              break;
            case 'Despido':
              badgeClass += 'badge-error';
              break;
            default:
              badgeClass += 'badge-neutral';
          }

          // Determinar texto del estado
          const estadoTexto = incidencia.estado ? 'Completado' : 'Pendiente';
          const estadoClass = incidencia.estado ? 'badge-success' : 'badge-warning';

          fila.innerHTML = `
            <td class="font-semibold">#INC${incidencia.id_incidencia.toString().padStart(3, '0')}</td>
            <td>${obtenerNombreEmpleado(incidencia.id_empleado)}</td>
            <td>${formatearFecha(incidencia.fecha_incidencia)}</td>
            <td>
              <span class="${badgeClass}">${incidencia.tipo_incidencia}</span>
            </td>
            <td>
              <span class="badge ${estadoClass}">${estadoTexto}</span>
            </td>
            <td>
              <div class="flex space-x-2">
                <button class="btn btn-sm btn-circle btn-success" onclick="marcarCompletado(${incidencia.id_incidencia})">
                  ‚úì
                 </button>
                <button class="btn btn-sm btn-circle btn-warning" onclick="ponerEnEspera(${incidencia.id_incidencia})">
                  üí§
                </button>
                <div class="dropdown dropdown-end">
                  <div tabindex="0" role="button" class="btn btn-sm btn-circle">
                    ...
                  </div>
                  <ul tabindex="0" class="dropdown-content absolute z-[9999] menu p-2 shadow bg-base-100 rounded-box w-52">
                    <li><a onclick="verDetalles(${incidencia.id_incidencia})">Ver detalles</a></li>
                    <li><a onclick="editarIncidencia(${incidencia.id_incidencia})">Editar</a></li>
                    <li><a onclick="mostrarModalEliminar(${incidencia.id_incidencia})">Eliminar</a></li>
                  </ul>
                </div>
              </div>
            </td>
          `;
          
          cuerpoTabla.appendChild(fila);
        });

        // Si no hay resultados, mostrar mensaje
        if (incidenciasFiltradas.length === 0) {
          const filaVacia = document.createElement('tr');
          filaVacia.innerHTML = `
            <td colspan="6" class="text-center py-4 text-gray-500">
              No se encontraron incidencias con los filtros aplicados
            </td>
          `;
          cuerpoTabla.appendChild(filaVacia);
        }
      }

      // Funciones de filtrado
      function filtrarPorTipo(tipo) {
        filtroTipoActual = tipo;
        renderizarTabla();
        
        // Actualizar pesta√±as de estado
        document.querySelectorAll('#filtro-estado .tab').forEach(tab => {
          tab.classList.remove('tab-active');
        });
        document.querySelector('#filtro-estado .tab').classList.add('tab-active');
        filtroEstadoActual = 'todos';
      }

      function filtrarPorEstado(estado) {
        filtroEstadoActual = estado;
        renderizarTabla();
        
        // Actualizar pesta√±as activas
        document.querySelectorAll('#filtro-estado .tab').forEach(tab => {
          tab.classList.remove('tab-active');
        });
        event.target.classList.add('tab-active');
      }

      // Funciones de acci√≥n para los botones
      async function marcarCompletado(id) {
        try {
          const incidencia = incidencias.find(i => i.id_incidencia === id);
          if (incidencia) {
            const datosActualizados = {
              estado: true
            };

            const response = await fetch(`${API_BASE_URL}/incidencias/${id}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(datosActualizados)
            });

            if (!response.ok) {
              throw new Error('Error al actualizar la incidencia');
            }

            // Actualizar datos locales
            incidencia.estado = true;
            alert(`Incidencia #INC${id.toString().padStart(3, '0')} marcada como completada`);
            renderizarTabla();
          }
        } catch (error) {
          manejarError(error, 'Error al marcar como completado');
        }
      }

      async function ponerEnEspera(id) {
        try {
          const incidencia = incidencias.find(i => i.id_incidencia === id);
          if (incidencia) {
            const datosActualizados = {
              estado: false
            };

            const response = await fetch(`${API_BASE_URL}/incidencias/${id}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(datosActualizados)
            });

            if (!response.ok) {
              throw new Error('Error al actualizar la incidencia');
            }

            // Actualizar datos locales
            incidencia.estado = false;
            alert(`Incidencia #INC${id.toString().padStart(3, '0')} puesta en espera`);
            renderizarTabla();
          }
        } catch (error) {
          manejarError(error, 'Error al poner en espera');
        }
      }

      function verDetalles(id) {
        const incidencia = incidencias.find(i => i.id_incidencia === id);
        if (incidencia) {
          const empleado = empleados.find(e => e.id_empleado === incidencia.id_empleado);
          document.getElementById('modal-titulo').textContent = `Detalles: #INC${id.toString().padStart(3, '0')}`;
          document.getElementById('modal-contenido').innerHTML = `
            <div class="space-y-4">
              <div><strong>Empleado:</strong> ${obtenerNombreEmpleado(incidencia.id_empleado)}</div>
              <div><strong>Correo:</strong> ${empleado ? empleado.correo_empresa : 'No disponible'}</div>
              <div><strong>Fecha:</strong> ${formatearFecha(incidencia.fecha_incidencia)}</div>
              <div><strong>Tipo:</strong> ${incidencia.tipo_incidencia}</div>
              <div><strong>Estado:</strong> ${incidencia.estado ? 'Completado' : 'Pendiente'}</div>
              <div><strong>Descripci√≥n:</strong> ${incidencia.descripcion_incidencia || 'No especificada'}</div>
              <div><strong>Acci√≥n Tomada:</strong> ${incidencia.accion_tomada || 'No especificada'}</div>
              ${incidencia.evidencia_incidencia ? `<div><strong>Evidencia:</strong> ${incidencia.evidencia_incidencia}</div>` : ''}
            </div>
          `;
          document.getElementById('modal-detalles').checked = true;
        }
      }

      function editarIncidencia(id) {
        const incidencia = incidencias.find(i => i.id_incidencia === id);
        if (incidencia) {
          incidenciaAEditar = id;
          
          // Llenar el formulario con los datos actuales
          document.getElementById('edit-tipo-incidencia').value = incidencia.tipo_incidencia;
          document.getElementById('edit-estado-incidencia').value = incidencia.estado.toString();
          document.getElementById('edit-descripcion-incidencia').value = incidencia.descripcion_incidencia || '';
          document.getElementById('edit-accion-tomada').value = incidencia.accion_tomada || '';
          
          document.getElementById('modal-editar').checked = true;
        }
      }

      async function guardarCambios() {
        if (incidenciaAEditar) {
          try {
            const datosActualizados = {
              tipo_incidencia: document.getElementById('edit-tipo-incidencia').value,
              estado: document.getElementById('edit-estado-incidencia').value === 'true',
              descripcion_incidencia: document.getElementById('edit-descripcion-incidencia').value,
              accion_tomada: document.getElementById('edit-accion-tomada').value
            };

            const response = await fetch(`${API_BASE_URL}/incidencias/${incidenciaAEditar}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(datosActualizados)
            });

            if (!response.ok) {
              throw new Error('Error al actualizar la incidencia');
            }

            // Actualizar datos locales
            const incidencia = incidencias.find(i => i.id_incidencia === incidenciaAEditar);
            if (incidencia) {
              Object.assign(incidencia, datosActualizados);
            }

            alert(`Cambios guardados para la incidencia #INC${incidenciaAEditar.toString().padStart(3, '0')}`);
            document.getElementById('modal-editar').checked = false;
            incidenciaAEditar = null;
            renderizarTabla();
          } catch (error) {
            manejarError(error, 'Error al guardar cambios');
          }
        }
      }

      function mostrarModalEliminar(id) {
        const incidencia = incidencias.find(i => i.id_incidencia === id);
        if (incidencia) {
          incidenciaAEliminar = id;
          document.getElementById('texto-eliminar').textContent = 
            `¬øEst√° seguro de eliminar la incidencia #INC${id.toString().padStart(3, '0')} de ${obtenerNombreEmpleado(incidencia.id_empleado)}?`;
          document.getElementById('modal-eliminar').checked = true;
        }
      }

      async function confirmarEliminar() {
        if (incidenciaAEliminar) {
          try {
            const response = await fetch(`${API_BASE_URL}/incidencias/${incidenciaAEliminar}`, {
              method: 'DELETE'
            });

            if (!response.ok) {
              throw new Error('Error al eliminar la incidencia');
            }

            // Actualizar datos locales
            const index = incidencias.findIndex(i => i.id_incidencia === incidenciaAEliminar);
            if (index !== -1) {
              incidencias.splice(index, 1);
            }

            actualizarEstadisticas();
            renderizarTabla();
            alert(`Incidencia #INC${incidenciaAEliminar.toString().padStart(3, '0')} eliminada correctamente`);
            document.getElementById('modal-eliminar').checked = false;
            incidenciaAEliminar = null;
          } catch (error) {
            manejarError(error, 'Error al eliminar incidencia');
          }
        }
      }

// Funci√≥n para mostrar modal del reporte de despidos (solo los que tengan tipo "Despido")
function mostrarModalReporteDespidos() {
  // Obtener todas las incidencias que sean de tipo "Despido"
  const despidosFiltrados = incidencias.filter(i => i.tipo_incidencia === 'Despido');

  // Referencia al cuerpo de la tabla del modal
  const tablaDespidos = document
    .getElementById('tabla-reporte-despidos')
    .getElementsByTagName('tbody')[0];
  
  // Limpiar contenido previo
  tablaDespidos.innerHTML = '';

  // Si no hay despidos registrados, mostrar mensaje
  if (despidosFiltrados.length === 0) {
    const filaVacia = tablaDespidos.insertRow();
    filaVacia.innerHTML = `
      <td colspan="4" class="text-center py-4 text-gray-500">
        No hay incidencias registradas con tipo "Despido".
      </td>
    `;
  } else {
    // Llenar la tabla con los despidos reales
    despidosFiltrados.forEach(despido => {
      const fila = tablaDespidos.insertRow();
      fila.innerHTML = `
        <td>${obtenerNombreEmpleado(despido.id_empleado)}</td>
        <td>${formatearFecha(despido.fecha_incidencia)}</td>
        <td>${despido.descripcion_incidencia || 'Sin causa registrada'}</td>
        <td>${despido.estado ? 'Completado' : 'En proceso'}</td>
      `;
    });
  }

  // Actualizar los contadores del resumen
  document.getElementById('resumen-total-despidos').textContent = despidosFiltrados.length;
  document.getElementById('resumen-despidos-proceso').textContent =
    despidosFiltrados.filter(d => !d.estado).length;
  document.getElementById('resumen-despidos-completados').textContent =
    despidosFiltrados.filter(d => d.estado).length;

  // Abrir el modal
  document.getElementById('modal-reporte-despidos').checked = true;
}

      function mostrarModalReporteGeneral() {
        // Actualizar datos del modal general
        const tablaGeneral = document.getElementById('tabla-reporte-general').getElementsByTagName('tbody')[0];
        tablaGeneral.innerHTML = '';
        
        incidencias.forEach(incidencia => {
          const fila = tablaGeneral.insertRow();
          fila.innerHTML = `
            <td class="font-semibold">#INC${incidencia.id_incidencia.toString().padStart(3, '0')}</td>
            <td>${obtenerNombreEmpleado(incidencia.id_empleado)}</td>
            <td>${formatearFecha(incidencia.fecha_incidencia)}</td>
            <td>${incidencia.tipo_incidencia}</td>
          `;
        });
        
        // Actualizar resumen
        document.getElementById('resumen-total').textContent = incidencias.length;
        document.getElementById('resumen-retardos').textContent = 
          incidencias.filter(i => i.tipo_incidencia === 'Retardo').length;
        document.getElementById('resumen-enfermedad').textContent = 
          incidencias.filter(i => i.tipo_incidencia === 'Enfermedad').length;
        document.getElementById('resumen-despidos').textContent = 
          incidencias.filter(i => i.tipo_incidencia === 'Despido').length;
        
        document.getElementById('modal-reporte-general').checked = true;
      }

      // Funciones para generar reportes
      function generarReporteDespidos() {
        alert('Generando reporte de despidos en PDF...');
        document.getElementById('modal-reporte-despidos').checked = false;
      }

      function generarReporteGeneral() {
        alert('Generando reporte general de incidencias en PDF...');
        document.getElementById('modal-reporte-general').checked = false;
      }
    </script>
  </body>
</html>ody>
</html>