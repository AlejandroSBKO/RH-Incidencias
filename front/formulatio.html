<!DOCTYPE html>
<html lang="es" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro de Incidencias</title>

    <!-- Tailwind + DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css"
      rel="stylesheet"
      type="text/css"
    />

    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
    </style>
  </head>

  <body class="bg-base-300 h-screen flex flex-col">
    <!-- Header -->
    <header class="navbar bg-orange-400 text-white px-6 h-16 flex-none">
      <div class="flex-1">
        <h1 class="text-2xl font-bold">Incidencias: Registro</h1>
      </div>
      <div class="flex-none text-3xl font-bold">H</div>
    </header>

    <main class="flex flex-1 overflow-hidden">
      <aside
        class="w-64 bg-base-100 p-6 shadow-md flex flex-col h-full justify-between"
      >
        <h2 class="text-xl font-semibold mb-6">Men煤</h2>
        <div class="flex flex-col space-y-3 flex-grow">
          <a href="dashboard.html"
            class="btn bg-orange-400 hover:bg-yellow-500 text-black font-semibold w-full"
          >
            Inicio
          </a>

          <button class="btn btn-neutral w-full">Crear Incidencia</button>
          <a href="busqueda.html"
            class="btn bg-orange-400 hover:bg-yellow-500 text-black font-semibold w-full"
          >Buscar Incidencia</a>
        </div>
        <div class="mt-auto text-sm text-center text-gray-500 pt-4 border-t border-gray-300">
          Incidencias y Despidos
        </div>
      </aside>

      <!-- Secci贸n del formulario -->
      <section class="flex-1 overflow-auto p-8 flex flex-col items-start justify-start">
        <div class="card w-full bg-base-100 shadow-xl p-8 rounded-box">
          <!-- Bot贸n para regresar -->
          <div class="mb-4">
            <button class="btn btn-sm btn-ghost gap-2 text-gray-600 hover:text-black">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5"/>
              </svg>
              Regresar
            </button>
          </div>

          <!-- Formulario -->
          <form class="space-y-5">
            <!-- ID de empleado -->
            <div>
              <label class="label font-semibold">ID de empleado</label>
              <div class="join w-full">
                <input
                  type="text"
                  id="idEmpleado"
                  placeholder="Buscar ID..."
                  class="input input-bordered join-item w-full"
                />
                <button type="button" id="btnBuscarEmpleado" class="btn join-item bg-base-200">
                  
                </button>
              </div>  
            </div>

            <!-- Foto del empleado -->
            <div class="flex items-center gap-4">
              <div class="avatar">
                <div class="w-24 rounded-full ring ring-base-300 ring-offset-base-100 ring-offset-2">
                  <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Foto del empleado" id="fotoEmpleado"/>
                </div>
              </div>
              <p class="text-sm text-gray-500" id="nombreAreaEmpleado">
                Foto del empleado
              </p>
            </div>

            <!-- Datos del empleado -->
            <div>
              <label class="label font-semibold">Datos del empleado</label>
              <textarea
                id="datosEmpleado"
                class="textarea textarea-bordered w-full"
                placeholder="Nombre completo&#10;rea"
                rows="3"
                readonly
              ></textarea>
            </div>

            <!-- Tipo de incidencia -->
            <div>
              <label class="label font-semibold">Tipo de incidencia</label>
              <select id="tipoIncidencia" class="select select-bordered w-full">
                <option disabled selected>Seleccione un tipo</option>
                <option>Retardo</option>
                <option>Falta justificada</option>
                <option>Falta injustificada</option>
                <option>Accidente laboral</option>
                <option>Despido</option>
              </select>
            </div>

            <!-- Fecha y hora -->
            <div>
              <label class="label font-semibold">Fecha y hora</label>
              <input
                type="datetime-local"
                id="fechaHora"
                class="input input-bordered w-full"
                value=""
              />
            </div>

            <!-- Descripci贸n de incidencia -->
            <div>
              <label class="label font-semibold">Descripci贸n breve</label>
              <textarea
                id="descripcion"
                class="textarea textarea-bordered w-full"
                placeholder="Describa brevemente la incidencia"
                rows="3"
              ></textarea>
            </div>

            <!-- Adjuntar evidencia -->
            <div>
              <label class="label font-semibold">Adjuntar evidencia (opcional)</label>
              <input
                type="file"
                id="evidencia"
                class="file-input file-input-bordered w-full"
                accept="image/*,application/pdf"
              />
            </div>

            <!-- Botones -->
            <div class="flex justify-end gap-4 pt-4">
              <button type="button" id="btnCancelar" class="btn btn-ghost">Cancelar</button>
              <button id="btnProcesar" type="button" class="btn bg-neutral text-white">Procesar</button>
            </div>
          </form>
        </div>
      </section>
    </main>

    <!-- Modal de 茅xito -->
    <input type="checkbox" id="modalConfirmacion" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Incidencia agregada correctamente</h3>
            <p class="py-2">La incidencia se ha creado con 茅xito.</p>
            <div class="modal-action">
                <label for="modalConfirmacion" class="btn btn-neutral">Finalizar</label>
            </div>
        </div>
    </div>

    <!-- Modal: Confirmar Cancelar -->
    <input type="checkbox" id="modalCancelar" class="modal-toggle" />
    <div class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg">驴Cancelar registro?</h3>
        <p class="py-2">Se perder谩n los datos ingresados.</p>
        <div class="modal-action">
          <label id="confirmarCancelar" class="btn btn-error">S铆</label>
          <label for="modalCancelar" class="btn btn-neutral">No</label>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const idInput = document.getElementById('idEmpleado');
        const btnBuscar = document.getElementById('btnBuscarEmpleado');
        const datosEmpleado = document.getElementById('datosEmpleado');
        const nombreAreaEmpleado = document.getElementById('nombreAreaEmpleado');

        // --------------------- Buscar empleado ---------------------
        btnBuscar.addEventListener('click', async () => {
          const id = idInput.value.trim();
          if (!id) return alert("Ingresa un ID de empleado");

          try {
            const res = await fetch(`http://127.0.0.1:5000/empleados/${id}`);
            if (!res.ok) {
              const err = await res.json();
              alert(err.error || "Empleado no encontrado");
              datosEmpleado.value = "";
              nombreAreaEmpleado.textContent = "Foto del empleado";
              return;
            }
            const data = await res.json();
            datosEmpleado.value = `${data.nombre_completo}\n${data.area}`;
            nombreAreaEmpleado.textContent = `${data.nombre_completo} - ${data.area}`;
          } catch (err) {
            console.error(err);
            alert("Error al conectar con el servidor.");
          }
        });

        // --------------------- Procesar incidencia ---------------------
        const btnProcesar = document.getElementById('btnProcesar');
        btnProcesar.addEventListener('click', async () => {
          const idEmpleado = idInput.value.trim();
          const tipoIncidencia = document.getElementById('tipoIncidencia').value;
          const fechaHora = document.getElementById('fechaHora').value;
          const descripcion = document.getElementById('descripcion').value.trim();
          const evidenciaInput = document.getElementById('evidencia');
          const evidencia = evidenciaInput.files.length > 0 ? evidenciaInput.files[0].name : null;

          if (!idEmpleado) return alert("Ingresa el ID de empleado");
          if (tipoIncidencia === "Seleccione un tipo") return alert("Selecciona un tipo de incidencia");
          if (!fechaHora) return alert("Selecciona fecha y hora");
          if (!descripcion) return alert("Ingresa la descripci贸n");

          const incidencia = {
            id_empleado: parseInt(idEmpleado),
            fecha_incidencia: fechaHora,
            tipo_incidencia: tipoIncidencia,
            descripcion_incidencia: descripcion,
            evidencia_incidencia: evidencia,
            accion_tomada: null,
            estado: true
          };

          try {
            const res = await fetch('http://127.0.0.1:5000/incidencias', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(incidencia)
            });
            if (!res.ok) {
              const err = await res.json();
              alert(err.error || "Error al guardar incidencia");
              return;
            }

            // xito
            document.getElementById('modalConfirmacion').checked = true;
            document.querySelector('form').reset();
            nombreAreaEmpleado.textContent = "Foto del empleado";

          } catch (err) {
            console.error(err);
            alert("Error al conectar con el servidor.");
          }
        });

        // --------------------- Cancelar ---------------------
        const btnCancelar = document.getElementById('btnCancelar');
        const modalCancelar = document.getElementById('modalCancelar');
        const confirmarCancelar = document.getElementById('confirmarCancelar');

        btnCancelar.addEventListener('click', () => {
          modalCancelar.checked = true;
        });

        confirmarCancelar.addEventListener('click', () => {
          document.querySelector('form').reset();
          document.getElementById('nombreAreaEmpleado').textContent = "Foto del empleado";
          modalCancelar.checked = false;
        });
      });
    </script>
  </body>
</html>
